---
layout: layout.njk
title: 구단 분석
description: "KBO 10개 구단의 전력 분석, 경기 일정, 최신 뉴스와 인기 구단 순위를 한눈에 확인하세요."
---

{% block styles %}
<link rel="stylesheet" href="/style/team-base.css" />
{% endblock %}

{% block content %}
<h1 class="page-title">구단 분석</h1>

{# 🏆 인기 구단 포디움 (TOP 3) #}
{% if voteSummary and voteSummary.teams %}
  {% set voteTeams = voteSummary.teams %}
{% else %}
  {% set voteTeams = [] %}
{% endif %}

{% set topTeams = voteTeams | sort(attribute="teamTotalVotes") | reverse | slice(0, 3) %}

<section class="vote-podium-section">
  <h2>인기 구단 포디움</h2>
  {% if topTeams | length > 0 %}
    <div class="podium-wrapper">
      {% for team in topTeams %}
        <div class="podium-card podium-{{ loop.index }}">
          <img src="/images/{{ team.teamSlug }}.png" alt="{{ team.teamName }}" class="team-logo">
          <div class="team-info">
            <h3>{{ loop.index }}위 {{ team.teamName }}</h3>
            <p>{{ team.teamTotalVotes }}표</p>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="no-data">투표 데이터가 부족합니다.</p>
  {% endif %}
</section>

{# 🏟️ 이번 주 경기 일정 캘린더 #}
{% set today = "now" | date("yyyy-MM-dd") %}
{% set nextWeek = (("now" | date("timestamp")) + (7 * 24 * 60 * 60 * 1000)) | date("yyyy-MM-dd") %}
{% set weeklyGames = scheduleArray 
  | selectattr("date", "defined") 
  | selectattr("date", "ge", today) 
  | selectattr("date", "le", nextWeek) 
  | sort(attribute="date") %}

<section class="calendar-section">
  <h2>이번 주 경기 일정</h2>
  {% if weeklyGames | length > 0 %}
    <div class="calendar-grid">
      {% set dates = weeklyGames | map(attribute="date") | unique %}
      {% for date in dates %}
        <div class="calendar-day">
          <h3>{{ date | date("MM.dd (EEE)") }}</h3>
          <ul>
            {% for game in weeklyGames if game.date == date %}
              <li>
                <img src="/images/{{ game.homeSlug }}.png" alt="{{ game.home }}" class="team-logo">
                {{ game.home }} vs 
                <img src="/images/{{ game.awaySlug }}.png" alt="{{ game.away }}" class="team-logo">
                {{ game.away }}
                <span class="status">
                  {% if game.winner == "취소" %}
                    취소
                  {% elseif game.winner == "예정" or (not game.homeScore and not game.awayScore) %}
                    예정
                  {% elseif game.status in ["승","패","무"] %}
                    {{ game.status }}
                  {% else %}
                    예정
                  {% endif %}
                </span>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="no-data">이번 주 경기 일정이 없습니다.</p>
  {% endif %}
</section>

{# 📋 전체 구단 카드 리스트 #}
{% if teamsBoard and teamsBoard is iterable %}
  {% set teamsArray = teamsBoard %}
{% else %}
  {% set teamsArray = [] %}
{% endif %}

<section class="teams-card-section">
  {% for team in teamsArray | sort(attribute="rank") %}
    {% set voteCount = 0 %}
    {% for vote in voteTeams %}
      {% if vote.teamSlug == team.slug %}
        {% set voteCount = vote.teamTotalVotes %}
      {% endif %}
    {% endfor %}
    <div class="team-card team-{{ team.slug }}">
      <a href="/teams/{{ team.slug }}/">
        <img src="/images/{{ team.slug }}.png" alt="{{ team.name }}">
        <div class="team-info">
          <h3>{{ team.name }}</h3>
          <p>순위: {{ team.rank }}위 | 승률: {{ (team.winRate * 100) | round(1) }}%</p>
          <span class="last-game 
            {% if team.lastGame == '승' %}win
            {% elseif team.lastGame == '패' %}lose
            {% elseif team.lastGame == '무' %}draw
            {% endif %}">
            최근 경기: {{ team.lastGame }}
          </span>
          <span class="vote-count">투표 수: {{ voteCount }}표</span>
        </div>
      </a>
      <button class="vote-btn" data-type="team" data-slug="{{ team.slug }}">
        이 구단에 투표하기
      </button>
    </div>
  {% endfor %}
</section>

<script type="module">
  import { handleVote } from "/scripts/voteHandler.js";
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".vote-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        handleVote(btn.dataset.type, btn.dataset.slug);
      });
    });
  });
</script>
{% endblock %}